# Передача данных по протоколам Protobuf и gRPC (плагин Protobuf)

По умолчанию Elektronik формат обмена данными
[google protocol buffers](https://developers.google.com/protocol-buffers/?hl=en) и [gRPC](https://grpc.io/).
Все данные передаются в Elektronik в виде пакетов. 
Спецификацию пакетов в формате protobuf можно найти в файле 
[MapTypes.proto](../plugins/Protobuf/Data/MapTypes.proto)

Существует несколько типов пакетов:
1. Пакет с действиями
2. Пакет с изображением

# Пакеты с действиями 

Каждый такой пакет содержит:
1. Действие над данными:
    * Добавление (add)
    * Обновление (update)
    * Удаление (remove)
    * Очистка (clear)
    * Вывод информации (info)
2. Временную метку пакета (timestamp)
3. Флаг ключевого пакета (special)
4. Сообщение (message)
5. Набор соединений
6. Данные
    * Точки
    * Наблюдения
    * Линии
    * Отслеживаемые объекты
    * Бесконечные плоскости

## Действия над данными

Всего над данными может быть совершено 4 действия:
1. Добавление (add). Этим действием необходимые объекты добавляются в карту. 
   Необходимо отметить, что без добавления объектов в карту с ними невозможно будет взаимодействовать в дальнейшем. 
   При попытке обращения к несуществующему объекту в Elektronik возникнет ошибка.
2. Обновление (update). Заменяет параметры объекта в соответствии с полученными данными.
3. Удаление (remove). Удаляет из карты объект.
4. Очистка (clear). Очищает карту соответствующего типа объектов.
5. Вывод информации (info). Выводит доплнительную информацию в оффлайн режиме.

## Временная метка

Временная метка используется в offline режиме работы Elektronik, 
она отображается на ползунке перемотки действий в нижнем правом углу экрана. 
Так же по ней будет отображаться соответствующее изображение с камеры. 
Файл с изображением должен называться \<timestamp\>.png.

В online режиме эта информация никак не используется.

## Флаг ключевого пакета

Флаг ключевого пакета используется в offline режиме, он предназначен для того, 
чтобы пропускать действия не представляющие интереса по нажатию кнопок перемотки до ближайшего ключевого пакета.

## Сообщение

Сообщение отображается в offline режиме для всех ключевых пакетов в правом верхнем углу экрана.

## Набор соединений

Набор соединений предназначен для отображения линий между объектами, такими как точки или наблюдения. 
Соединение представляет собой пару целочисленных значений содержащих id соединяемых объектов. 
На текущий момент соединения возможно установить только между объектами одного типа, т. е. нельзя соединить точку с наблюдением. 
Стоит отметить, что при обновлении объекта соединение также будет автоматически обновлено.

Набор соединений помимо собственно самих соединений также содержит действие. Действие может быть одно из двух:
* Добавление (add)
* Удаление (remove)

В обоих случаях действие может быть совершено только над присутствующими объектами в карте, 
при этом соединения имеют эффект только для обновления объектов. Например, чтобы добавить (удалить) соединение между двумя точками, 
необходимо послать пакет с действием обновления точек и действием добавления (удаления) для соединений. 
При этом соединения могут быть добавлены и без фактического обновления объектов, т. е. можно сформировать пакет 
в котором набор объектов будет пустым, а набор соединений - не пустым.

## Данные

На текущий момент несколько типов данных:
1. Точки
2. Наблюдения
3. Линии
4. Отслеживаемые объекты
5. Бесконечные плоскости

Любой пакет должен содержать набор объектов одного указанного выше типа.

### Точки

Для точек передаются следующие данные:
1. ID точки.
2. Позиция точки
3. Цвет точки
4. Сообщение

### Наблюдения

Для наблюдений передаются следующие данные:
1. Точка к которой привязано наблюдение
2. Кватернион ориентации наблюдения
3. Сообщение
4. Имя файла с изображением снятым камерой во время этого наблюдения
5. Статистика (не используется)

### Линии

Для линий передаются следующие данные:
1. Первая соединяемая точка
2. Вторая соединяемая точка

### Отслеживаемые объекты

Под отслеживаемыми объектами понимаются, такие объекты у которых задано положение и ориентация в пространстве,
а также отслеживается пройденная ими траектория.
К таким объектам могут относиться, например, VR-шлем или устройство для снятия данных для SLAM.

Для отслеживаемых объектов передаются следующие данные:
1. ID отлеживаемого объекта
2. Положение объекта
3. Кватернион ориентации объекта
4. Цвет траектории
5. Сообщение

### Бесконечные плоскости

Для бесконечных плоскостей передаются следующие данные:
1. ID плоскости
2. Точка на плоскости
3. Нормаль к плоскости
4. Цвет
5. Сообщение

# Пакеты с изображением

Данный тип пакетов предназначен для передачи изображений с камеры в онлайн режиме.
Он содержит массив байт изображения в формате PNG или JPEG.

# Метаданные

В конце файла может находиться дополнительная метаинформация. 
Сейчас там может находится только одно Int32 значение - количество пакетов.
Перед метаданными должен быть специальный маркер *0xDEADBEEF*.
Таким образом на данный момент метаданные - это 8 байт: маркер и количество кадров.
# C#

C примером взаимодействия с Elektronik можно ознакомиться в папке Examples/csharp в корне репозитория. 
Пример выполнен в виде Unit-тестов, перед запуском тестов необходимо запустить Elektronik в онлайн режиме, 
после запуска тестов в папке с исполняемыми файлами появятся файлы \<TestName\>.dat, которые можно использовать 
в качестве демонстрации возможностей Elektronik в offline режиме.

# C++

C примером взаимодействия с Elektronik можно ознакомиться в папке Examples/cxx в корне репозитория. 
Пример выполнен в виде google tests Unit-тестов. Для сборки этого примера рекомендуется использовать 
[vcpkg](https://github.com/Microsoft/vcpkg).

[<- Написать свой плагин](Plugins-RU.md) | [К стартовой странице](Home-RU.md)